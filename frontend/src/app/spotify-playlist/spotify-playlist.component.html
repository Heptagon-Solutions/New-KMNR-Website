<div class="spotify-playlist-container">
  <h2>KMNR Spotify Integration</h2>

  <!-- Authentication Section -->
  <div *ngIf="!isAuthenticated" class="auth-section">
    <div class="connect-wrapper">
      <h3>üéµ Connect to Spotify</h3>
      <p>Connect your Spotify account to view and manage your playlists</p>
      <button (click)="authenticateWithSpotify()" class="btn btn-spotify">
        Connect to Spotify
      </button>
    </div>
  </div>

  <!-- Main Interface -->
  <div *ngIf="isAuthenticated" class="main-interface">
    
    <!-- User Profile Section -->
    <div *ngIf="userProfile" class="user-profile-section">
      <div class="profile-header">
        <div class="profile-avatar">
          <img 
            *ngIf="userProfile.images && userProfile.images.length > 0; else defaultAvatar" 
            [src]="userProfile.images[0].url" 
            [alt]="userProfile.display_name + ' profile'"
            class="avatar-image">
          <ng-template #defaultAvatar>
            <div class="default-avatar">{{ userProfile.display_name.charAt(0) || 'U' }}</div>
          </ng-template>
        </div>
        <div class="profile-info">
          <h3>Welcome, {{ userProfile.display_name || 'Spotify User' }}!</h3>
          <div class="profile-details">
            <span class="user-id">{{ userProfile.id }}</span>
            <span class="user-product" *ngIf="userProfile.product">{{ userProfile.product | titlecase }}</span>
            <span class="user-followers">{{ userProfile.followers.total }} followers</span>
          </div>
        </div>
        <button (click)="disconnect()" class="btn btn-disconnect">
          Disconnect Spotify
        </button>
      </div>
    </div>

    <!-- Navigation -->
    <div class="navigation-tabs">
      <button 
        (click)="currentView = 'playlists'" 
        [class.active]="currentView === 'playlists'"
        class="nav-tab">
        üìã Your Playlists
      </button>
      <button 
        (click)="switchToSearch()" 
        [class.active]="currentView === 'search'"
        class="nav-tab">
        üîç Search & Create
      </button>
    </div>

    <!-- Loading Indicator -->
    <div *ngIf="isLoading" class="loading-indicator">
      <p>Loading...</p>
    </div>

    <!-- Playlists View -->
    <div *ngIf="currentView === 'playlists' && !isLoading" class="playlists-view">
      <div class="playlists-summary">
        <h4>Found {{ userPlaylists.length }} playlists</h4>
        <p>Click any playlist to view its tracks</p>
      </div>
      
      <div class="playlists-grid" *ngIf="userPlaylists.length > 0">
        <div *ngFor="let playlist of userPlaylists" class="playlist-item" (click)="showPlaylistTracks(playlist)">
          <div class="playlist-content">
            <h4>{{ playlist.name }}</h4>
            <p class="track-count">Tracks: {{ playlist.tracks.total }}</p>
            <p class="playlist-owner">Owner: {{ playlist.owner.display_name || playlist.owner.id }}</p>
            <p class="playlist-type">
              {{ playlist.public ? 'Public' : 'Private' }} ‚Ä¢ 
              {{ playlist.collaborative ? 'Collaborative' : 'Solo' }}
            </p>
            <p class="click-hint">Click to view tracks</p>
          </div>
        </div>
      </div>

      <div *ngIf="userPlaylists.length === 0" class="no-playlists">
        <p>No playlists found. Create some playlists in Spotify first!</p>
      </div>
    </div>

    <!-- Playlist Tracks View -->
    <div *ngIf="currentView === 'tracks' && !isLoading" class="tracks-view">
      <div class="playlist-tracks-header">
        <button (click)="backToPlaylists()" class="btn btn-back">‚Üê Back to Playlists</button>
        <h3>{{ selectedPlaylistForView?.name }}</h3>
        <p>{{ selectedPlaylistTracks.length }} tracks</p>
      </div>

      <div class="tracks-list" *ngIf="selectedPlaylistTracks.length > 0">
        <div *ngFor="let item of selectedPlaylistTracks; let i = index" class="track-item">
          <div class="track-number">{{ i + 1 }}</div>
          <div class="track-info">
            <div class="track-name">
              {{ item.track.name || 'Unknown Track' }}
              <span *ngIf="item.track?.explicit" class="explicit-badge">E</span>
            </div>
            <div class="track-artist">{{ getArtistNames(item.track.artists || []) }}</div>
            <div class="track-album">{{ item.track.album.name || 'Unknown Album' }}</div>
          </div>
          <div class="track-meta">
            <div class="track-duration">{{ formatDuration(item.track.duration_ms || 0) }}</div>
            <div class="track-added">Added: {{ formatDate(item.added_at) }}</div>
          </div>
        </div>
      </div>

      <div *ngIf="selectedPlaylistTracks.length === 0" class="empty-playlist">
        <p>This playlist is empty.</p>
      </div>
    </div>

    <!-- Search and Create View -->
    <div *ngIf="currentView === 'search' && !isLoading" class="search-view">
      <!-- Search Section -->
      <div class="search-section">
        <h3>Search for Songs</h3>
        <div class="search-input-group">
          <input 
            type="text" 
            [(ngModel)]="searchQuery" 
            placeholder="Search for songs, artists, or albums..."
            (keydown)="onEnterPressed($event)"
            class="search-input">
          <button (click)="searchTracks()" [disabled]="isLoading || !searchQuery.trim()" class="btn btn-search">
            Search
          </button>
        </div>
      </div>

      <!-- Search Results -->
      <div *ngIf="searchPerformed && searchResults.length > 0" class="search-results">
        <h4>Search Results</h4>
        <div class="track-list">
          <div *ngFor="let track of searchResults" class="track-item">
            <div class="track-info">
              <strong>{{ track.name }}</strong>
              <span *ngIf="track.explicit" class="explicit-badge">E</span>
              <span class="artist">by {{ getArtistNames(track.artists) }}</span>
              <span class="album">from {{ track.album.name }}</span>
            </div>
            <button 
              (click)="addToPlaylist(track)" 
              [disabled]="isTrackSelected(track)"
              class="btn btn-add">
              {{ getAddButtonText(track) }}
            </button>
          </div>
        </div>
      </div>

      <!-- No Results Message -->
      <div *ngIf="searchPerformed && searchResults.length === 0" class="no-results">
        <p>No tracks found. Try a different search term.</p>
      </div>

      <!-- Selected Tracks / Playlist Builder -->
      <div *ngIf="selectedTracks.length > 0" class="playlist-section">
        <h3>New Playlist ({{ selectedTracks.length }} songs)</h3>
        
        <div class="playlist-controls">
          <input 
            type="text" 
            [(ngModel)]="playlistName" 
            placeholder="Enter playlist name"
            class="playlist-name-input">
          <button (click)="createPlaylist()" [disabled]="isLoading || !playlistName.trim()" class="btn btn-create">
            Create Playlist
          </button>
          <button (click)="clearPlaylist()" class="btn btn-clear">Clear All</button>
        </div>

        <div class="selected-tracks">
          <div *ngFor="let track of selectedTracks" class="selected-track-item">
            <div class="track-info">
              <strong>{{ track.name }}</strong>
              <span *ngIf="track.explicit" class="explicit-badge">E</span>
              <span class="artist">by {{ getArtistNames(track.artists) }}</span>
            </div>
            <button (click)="removeFromPlaylist(track)" class="btn btn-remove">Remove</button>
          </div>
        </div>
      </div>

      <!-- Successful Playlist Creation -->
      <div *ngIf="currentPlaylist" class="success-section">
        <h3>‚úÖ Playlist Created Successfully!</h3>
        <p><strong>{{ currentPlaylist.name }}</strong> has been created with {{ selectedTracks.length }} songs.</p>
        <div class="success-actions">
          <button (click)="openInSpotify()" class="btn btn-spotify-open">
            üéµ Open in Spotify
          </button>
          <button (click)="currentView = 'playlists'; loadUserPlaylists()" class="btn btn-view-playlists">
            üìã View All Playlists
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
